# Ubuntu Hardened Base Image
# Security-hardened Ubuntu base following CIS benchmarks
base: docker.io/ubuntu:24.04
package_manager: apt
multi_arch: true
workdir: /app

tools:
  # Essential security packages
  - name: security-base
    description: Security baseline packages
    method: script
    script: |
      apt-get update
      apt-get install -y --no-install-recommends ca-certificates tzdata
      rm -rf /var/lib/apt/lists/*

  # System hardening
  - name: hardening
    description: CIS and DevSec security hardening
    method: script
    script: |
      # Remove shells for system accounts
      sed -i 's|/bin/bash|/usr/sbin/nologin|g' /etc/passwd
      sed -i 's|/bin/sh|/usr/sbin/nologin|g' /etc/passwd
      # Restore root shell for build steps (final image should use nonroot)
      sed -i '/^root:/s|/usr/sbin/nologin|/bin/sh|' /etc/passwd

      # Restrict /etc permissions
      chmod 600 /etc/shadow
      chmod 644 /etc/passwd
      chmod 644 /etc/group

      # Remove world-writable permissions on files
      find / -xdev -type f -perm -0002 -exec chmod o-w {} \; 2>/dev/null || true

      # Set sticky bit on world-writable directories
      find / -xdev -type d -perm -0002 ! -perm -1000 -exec chmod +t {} \; 2>/dev/null || true

      # Remove SUID/SGID binaries (security risk)
      find / -xdev -type f \( -perm -4000 -o -perm -2000 \) -exec chmod a-s {} \; 2>/dev/null || true

      # Remove unnecessary users
      deluser --remove-home games 2>/dev/null || true
      deluser --remove-home news 2>/dev/null || true
      deluser --remove-home uucp 2>/dev/null || true
      deluser --remove-home list 2>/dev/null || true
      deluser --remove-home irc 2>/dev/null || true
      deluser --remove-home gnats 2>/dev/null || true

      # Restrict cron (if present)
      rm -rf /etc/cron.* /var/spool/cron 2>/dev/null || true

      # Remove legacy auth files
      find / -xdev -name '.netrc' -o -name '.rhosts' -o -name '.forward' | xargs rm -f 2>/dev/null || true

      # Empty securetty to prevent root console login
      echo "" > /etc/securetty 2>/dev/null || true

      # Disable core dumps
      mkdir -p /etc/security/limits.d
      echo "* hard core 0" > /etc/security/limits.d/99-no-core-dumps.conf

      # Set restrictive umask
      echo "umask 027" >> /etc/profile

      # Remove SSH host keys (should be generated at runtime)
      rm -f /etc/ssh/ssh_host_*key* 2>/dev/null || true

      # Restrict gshadow if present
      chmod 600 /etc/gshadow 2>/dev/null || true

      # Remove temp files and apt cache
      rm -rf /tmp/* /var/tmp/* /var/lib/apt/lists/* /var/cache/apt/*

      # Create security audit file
      echo "Ubuntu Hardened - $(date -u +%Y-%m-%dT%H:%M:%SZ)" > /etc/hardened-version

  # Non-root user setup
  - name: nonroot-user
    description: Create non-root user for running applications
    method: script
    script: |
      mkdir -p /app
      groupadd -g 65532 nonroot
      useradd -u 65532 -g nonroot -d /app -s /usr/sbin/nologin -M nonroot
      chown -R nonroot:nonroot /app
