# Ubuntu Workstation Image Configuration
# Desktop environment with XFCE accessible via VNC
base: ghcr.io/labrats-work/infra.images/ubuntu-hardened:main
package_manager: apt
multi_arch: false
workdir: /home/user

build_args:
  - name: VNC_RESOLUTION
    default: "1920x1080"

tools:
  - name: core-utils
    description: Core utilities and build tools
    method: package
    package: curl wget git sudo locales

  - name: locale-setup
    description: Configure UTF-8 locale
    method: script
    script: |
      sed -i '/en_US.UTF-8/s/^# //' /etc/locale.gen
      locale-gen en_US.UTF-8

  - name: xfce-desktop
    description: XFCE4 lightweight desktop environment
    method: script
    script: |
      apt-get update
      DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends xfce4 xfce4-terminal xfce4-taskmanager dbus-x11 xfonts-base fonts-dejavu-core fonts-liberation libgl1-mesa-dri mesa-utils at-spi2-core
      rm -rf /var/lib/apt/lists/*

  - name: tigervnc
    description: TigerVNC server for remote desktop access
    method: script
    script: |
      apt-get update
      DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends tigervnc-standalone-server tigervnc-common
      rm -rf /var/lib/apt/lists/*

  - name: novnc
    description: noVNC HTML5 VNC client for browser access
    method: script
    script: |
      apt-get update
      DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends novnc websockify python3-minimal
      ln -sf /usr/share/novnc/vnc.html /usr/share/novnc/index.html
      rm -rf /var/lib/apt/lists/*

  - name: desktop-apps
    description: Common desktop applications
    method: package
    package: firefox xfce4-screenshooter mousepad file-roller

  - name: desktop-user
    description: Create desktop user with sudo access
    method: script
    script: |
      groupadd -g 1000 user
      useradd -u 1000 -g user -d /home/user -s /bin/bash -m user
      echo "user ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/user
      chmod 0440 /etc/sudoers.d/user
      mkdir -p /home/user/.vnc /home/user/Desktop
      chown -R user:user /home/user

  - name: vnc-startup
    description: VNC startup script
    method: script
    script: |
      printf '#!/bin/bash\nset -e\nVNC_PORT="${VNC_PORT:-5901}"\nNOVNC_PORT="${NOVNC_PORT:-6080}"\nRESOLUTION="${VNC_RESOLUTION:-1920x1080}"\nVNC_PW="${VNC_PASSWORD:-changeme}"\nmkdir -p ~/.vnc\necho "$VNC_PW" | vncpasswd -f > ~/.vnc/passwd\nchmod 600 ~/.vnc/passwd\nprintf '"'"'#!/bin/bash\\nunset SESSION_MANAGER\\nunset DBUS_SESSION_BUS_ADDRESS\\nexec startxfce4\\n'"'"' > ~/.vnc/xstartup\nchmod +x ~/.vnc/xstartup\nvncserver :1 -geometry "$RESOLUTION" -depth 24 -localhost no -SecurityTypes VncAuth\nwebsockify --web /usr/share/novnc "$NOVNC_PORT" localhost:"$VNC_PORT" &\necho "VNC on port $VNC_PORT, noVNC on port $NOVNC_PORT"\ntail -f /dev/null\n' > /usr/local/bin/start-vnc
      chmod +x /usr/local/bin/start-vnc
